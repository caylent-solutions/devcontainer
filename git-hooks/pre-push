#!/bin/bash

# Get the root directory of the git repository
ROOT_DIR=$(git rev-parse --show-toplevel)

# Check if we're pushing changes to the CLI, catalog, or common directories
if git diff --name-only HEAD @{u} 2>/dev/null | grep -qE "^(caylent-devcontainer-cli|catalog|common)/"; then
  echo "Running tests and linting for CLI/catalog/common changes before push..."
  cd "$ROOT_DIR/caylent-devcontainer-cli"

  # Run linting
  echo "Running lint..."
  if ! make lint; then
    echo "❌ Linting failed. Please fix the issues before pushing."
    exit 1
  fi

  # Run unit tests with coverage check
  echo "Running unit tests with coverage check..."
  if ! make unit-test; then
    echo "❌ Unit tests failed. Please fix the issues before pushing."
    exit 1
  fi

  # Check coverage threshold
  coverage_percent=$(python -m coverage report --format=total 2>/dev/null || echo "0")
  echo "Coverage: $coverage_percent%"
  if python -c "import sys; sys.exit(0 if float('${coverage_percent}') >= 90 else 1)"; then
    echo "Coverage meets 90% threshold."
  else
    echo "❌ Code coverage is below 90% threshold ($coverage_percent%). Please add more tests."
    exit 1
  fi

  # Run functional tests
  echo "Running functional tests..."
  if ! make functional-test; then
    echo "❌ Functional tests failed. Please fix the issues before pushing."
    exit 1
  fi

  echo "✅ All tests and linting passed!"
fi

# Always validate catalog structure
echo "Running catalog validation..."
cd "$ROOT_DIR"
if ! make validate-catalog; then
  echo "❌ Catalog validation failed. Please fix the issues before pushing."
  exit 1
fi
echo "✅ Catalog validation passed!"

exit 0
