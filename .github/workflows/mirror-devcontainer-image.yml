name: Mirror DevContainer Base Image

on:
  schedule:
    - cron: '0 6 1,15 * *' # 6 AM UTC on 1st and 15th of each month
  workflow_dispatch:        # Manual trigger and API/dispatch support

permissions:
  id-token: write # Required for OIDC authentication to AWS

env:
  SOURCE_IMAGE: mcr.microsoft.com/devcontainers/base:noble
  ECR_ALIAS: g0u3p4x2
  ECR_REPO: caylent-solutions/devcontainer-base
  IMAGE_TAG: noble
  AWS_REGION: us-east-1
  IAM_ROLE_ARN: ${{ vars.ECR_PUSH_ROLE_ARN }}

jobs:
  mirror:
    name: Mirror image to ECR Public
    runs-on: ubuntu-24.04
    steps:
      - name: Validate required configuration
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${IAM_ROLE_ARN}" ]]; then
            echo "::error::Repository variable ECR_PUSH_ROLE_ARN is not set. Configure it in Settings → Secrets and variables → Actions → Variables."
            exit 1
          fi

      - name: Install crane
        uses: imjasonh/setup-crane@v0.4

      - name: Check for upstream image update
        id: check
        shell: bash
        run: |
          set -euo pipefail

          ECR_IMAGE="public.ecr.aws/${ECR_ALIAS}/${ECR_REPO}:${IMAGE_TAG}"

          echo "Fetching upstream digest for ${SOURCE_IMAGE}..."
          UPSTREAM_DIGEST=$(crane digest "${SOURCE_IMAGE}" 2>/dev/null || echo "")
          if [[ -z "${UPSTREAM_DIGEST}" ]]; then
            echo "::error::Failed to fetch upstream digest from ${SOURCE_IMAGE}"
            exit 1
          fi
          echo "Upstream digest: ${UPSTREAM_DIGEST}"

          echo "Fetching ECR digest for ${ECR_IMAGE}..."
          ECR_DIGEST=$(crane digest "${ECR_IMAGE}" 2>/dev/null || echo "")
          if [[ -z "${ECR_DIGEST}" ]]; then
            echo "ECR image does not exist yet — will mirror"
            echo "changed=true" >> "${GITHUB_OUTPUT}"
          elif [[ "${UPSTREAM_DIGEST}" == "${ECR_DIGEST}" ]]; then
            echo "Digests match — no update needed"
            echo "changed=false" >> "${GITHUB_OUTPUT}"
          else
            echo "Digests differ — will mirror"
            echo "changed=true" >> "${GITHUB_OUTPUT}"
          fi

          SHORT_SHA="${UPSTREAM_DIGEST#sha256:}"
          SHORT_SHA="${SHORT_SHA:0:12}"
          echo "upstream_digest=${UPSTREAM_DIGEST}" >> "${GITHUB_OUTPUT}"
          echo "short_sha=${SHORT_SHA}" >> "${GITHUB_OUTPUT}"

      - name: Configure AWS credentials via OIDC
        if: steps.check.outputs.changed == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Authenticate crane to ECR Public
        if: steps.check.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          aws ecr-public get-login-password --region "${AWS_REGION}" \
            | crane auth login --username AWS --password-stdin public.ecr.aws

      - name: Copy image to ECR Public
        if: steps.check.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail

          ECR_TARGET="public.ecr.aws/${ECR_ALIAS}/${ECR_REPO}"
          VERSION_TAG="${IMAGE_TAG}-${{ steps.check.outputs.short_sha }}"

          echo "Copying ${SOURCE_IMAGE} -> ${ECR_TARGET}:${IMAGE_TAG}..."
          crane copy "${SOURCE_IMAGE}" "${ECR_TARGET}:${IMAGE_TAG}"

          echo "Copying ${SOURCE_IMAGE} -> ${ECR_TARGET}:${VERSION_TAG}..."
          crane copy "${SOURCE_IMAGE}" "${ECR_TARGET}:${VERSION_TAG}"

          echo "Mirror complete"

      - name: Job summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ steps.check.outputs.changed }}" != "true" ]]; then
            echo "### Mirror DevContainer Base Image" >> "${GITHUB_STEP_SUMMARY}"
            echo "No update needed — upstream and ECR digests match." >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "### Mirror DevContainer Base Image" >> "${GITHUB_STEP_SUMMARY}"
            echo "Image mirrored to ECR Public." >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "- **Upstream digest:** \`${{ steps.check.outputs.upstream_digest }}\`" >> "${GITHUB_STEP_SUMMARY}"
            echo "- **Rolling tag:** \`public.ecr.aws/${ECR_ALIAS}/${ECR_REPO}:${IMAGE_TAG}\`" >> "${GITHUB_STEP_SUMMARY}"
            echo "- **Version tag:** \`public.ecr.aws/${ECR_ALIAS}/${ECR_REPO}:${IMAGE_TAG}-${{ steps.check.outputs.short_sha }}\`" >> "${GITHUB_STEP_SUMMARY}"
          fi
